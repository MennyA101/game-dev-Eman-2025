<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            background-color: aqua;
        }
        h1 {
            display: flex;
        }
        form {
            display: flex;
            flex-direction: column;
        }
        label {
            font-weight: bold;
            text-align: center;
        }
        textarea, input, select, button {
            width: 50%;
            align-self: center;
            padding: 10px;

        }
    </style>
</head>
<body>

    <h1>t2a28-spy-cohen.html</h1>

    <form id="encryptForm">
        <label for="encryptBox">Data to be Encrypted</label>
        <textarea id="encryptBox">Encrypt me please!!</textarea>

        <label for="methodSelect">Encryption Method</label>
        <select id="methodSelect">
            <option value="shift">Shift Cipher (no key)</option>
            <option value="vigenere">Shift Cipher with Key (Vigenère style)</option>
            <option value="aes">AES Encryption with key</option>
        </select>

        <label for="keyBox">Key (optional)</label>
        <input type="text" id="keyBox" placeholder="Enter a key">

        <button type="button" id="encryptBtn">Encrypt</button>

        <label for="cipherText">Encrypted Output</label>
        <textarea id="cipherText" readonly></textarea>
    </form>

    <form id="decryptForm">
        <label for="decryptBox">Data to be Decrypted</label>
        <textarea id="decryptBox"></textarea>

        <label for="methodSelectDec">Decryption Method</label>
        <select id="methodSelectDec">
            <option value="shift">Shift Cipher (no key)</option>
            <option value="vigenere">Shift Cipher with Key (Vigenère style)</option>
            <option value="aes">AES Encryption with key</option>
        </select>

        <label for="keyBoxDec">Key (required for Vigenère method and AES)</label>
        <input type="text" id="keyBoxDec" placeholder="Enter the key">

        <button type="button" id="decryptBtn">Decrypt</button>

        <label for="plainText">Decrypted Output</label>
        <textarea id="plainText" readonly></textarea>
    </form>

    <script>
        const alphabet = "abcdefghijklmnopqrstuvwxyz ";
        const n = alphabet.length;


        function strToUint8(str) {
        return new TextEncoder().encode(str);
        }

        function uint8ToStr(buf) {
        return new TextDecoder().decode(buf);
        }

        function bufToBase64(buf) {
        return btoa(String.fromCharCode(...buf));
        }

        function base64ToBuf(base64) {
        return Uint8Array.from(atob(base64), c => c.charCodeAt(0));
        }

        // --- Derive a crypto key from a password string ---
        async function deriveKey(password, salt) {
        const keyMaterial = await crypto.subtle.importKey(
            "raw",
            strToUint8(password),
            "PBKDF2",
            false,
            ["deriveKey"]
        );

        return crypto.subtle.deriveKey(
            {
            name: "PBKDF2",
            salt,
            iterations: 100000,
            hash: "SHA-256"
            },
            keyMaterial,
            {
            name: "AES-GCM",
            length: 256
            },
            false,
            ["encrypt", "decrypt"]
        );
        }

        // --- Encrypt ---
        async function encrypt(password, plaintext) {
        const iv = crypto.getRandomValues(new Uint8Array(12));  // AES-GCM IV
        const salt = crypto.getRandomValues(new Uint8Array(16)); // for PBKDF2

        const key = await deriveKey(password, salt);

        const encrypted = await crypto.subtle.encrypt(
            { name: "AES-GCM", iv },
            key,
            strToUint8(plaintext)
        );

        // Return salt + iv + ciphertext as base64
        const combined = new Uint8Array([
            ...salt,
            ...iv,
            ...new Uint8Array(encrypted)
        ]);

        return bufToBase64(combined);
        }

        // --- Decrypt ---
        async function decrypt(password, ciphertextBase64) {
        const data = base64ToBuf(ciphertextBase64);

        const salt = data.slice(0, 16);
        const iv = data.slice(16, 28);
        const ciphertext = data.slice(28);

        const key = await deriveKey(password, salt);

        const decrypted = await crypto.subtle.decrypt(
            { name: "AES-GCM", iv },
            key,
            ciphertext
        );

        return uint8ToStr(new Uint8Array(decrypted));
        }

        // Shift cipher (forward)
        function shiftTextForward(text) {
            return [...text.toLowerCase()].map(char => {
                const i = alphabet.indexOf(char);
                if (i === -1) return char;
                return alphabet[(i + 1) % n];
            }).join("");
        }

        // Shift cipher (backward)
        function shiftTextBackward(text) {
            return [...text.toLowerCase()].map(char => {
                const i = alphabet.indexOf(char);
                if (i === -1) return char;
                return alphabet[(i - 1 + n) % n];
            }).join("");
        }

        // Vigenère-style encryption with key
        function vigenereEncrypt(text, key) {
            text = text.toLowerCase();
            key = key.toLowerCase().replace(/[^a-z]/g, '');
            if (!key) return text; // if no key, return original

            return [...text].map((char, idx) => {
                const i = alphabet.indexOf(char);
                if (i === -1) return char;
                const keyChar = key[idx % key.length];
                const keyShift = alphabet.indexOf(keyChar);
                return alphabet[(i + keyShift) % n];
            }).join("");
        }

        // Vigenère-style decryption with key
        function vigenereDecrypt(text, key) {
            text = text.toLowerCase();
            key = key.toLowerCase().replace(/[^a-z]/g, '');
            if (!key) return text;

            return [...text].map((char, idx) => {
                const i = alphabet.indexOf(char);
                if (i === -1) return char;
                const keyChar = key[idx % key.length];
                const keyShift = alphabet.indexOf(keyChar);
                return alphabet[(i - keyShift + n) % n];
            }).join("");
        }

        // Encryption button
        document.getElementById('encryptBtn').addEventListener('click', async () => {
            const text = document.getElementById('encryptBox').value;
            const method = document.getElementById('methodSelect').value;
            const key = document.getElementById('keyBox').value;

            let output;
            if (method === 'shift') output = shiftTextForward(text);
            else if (method === 'vigenere') output = vigenereEncrypt(text, key);
            else if (method === 'aes') output = await encrypt(key, text);

            document.getElementById('cipherText').value = output;
        });

        // Decryption button
        document.getElementById('decryptBtn').addEventListener('click', async () => {
            const text = document.getElementById('decryptBox').value;
            const method = document.getElementById('methodSelectDec').value;
            const key = document.getElementById('keyBoxDec').value;

            let output;
            if (method === 'shift') output = shiftTextBackward(text);
            else if (method === 'vigenere') output = vigenereDecrypt(text, key);
            else if (method === 'aes') output = await decrypt(key, text);

            document.getElementById('plainText').value = output;
        });
    </script>

</body>
</html>
